import database
import requests
import sys
from bs4 import BeautifulSoup
import google.generativeai as genai
from typing import List, Dict, Any
import json
import re
import os  # üëà –î–û–ë–ê–í–ï–ù–û
from dotenv import load_dotenv  # üëà –î–û–ë–ê–í–ï–ù–û

# ===================================================================
# ‚ö†Ô∏è –ù–û–í–ê –ß–ê–°–¢: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–∞–Ω–µ –Ω–∞ AI –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ
# ===================================================================
# –ó–∞—Ä–µ–∂–¥–∞–º–µ .env —Ñ–∞–π–ª–∞ –í–ï–î–ù–ê–ì–ê
load_dotenv()
API_KEY = os.getenv("GEMINI_API_KEY")

if not API_KEY:
    print("‚ùå [Logic] –ì–†–ï–®–ö–ê: GEMINI_API_KEY –Ω–µ –µ –Ω–∞–º–µ—Ä–µ–Ω –≤ .env —Ñ–∞–π–ª–∞.")
else:
    try:
        genai.configure(api_key=API_KEY)
        print("‚úÖ [Logic] Google AI –µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ.")
    except Exception as e:
        print(f"‚ùå [Logic] –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–∞–Ω–µ –Ω–∞ Google AI: {e}")


# ===================================================================
# –ß–ê–°–¢ 1: WEB SCRAPER
# ===================================================================

def get_kaufland_promotions(db_conn):
    """
    –ò–∑–≤–ª–∏—á–∞ –ø—Ä–æ–º–æ—Ü–∏–∏—Ç–µ –Ω–∞ Kaufland (–°–ê–ú–û –ò–ú–ï–ù–ê), –∫–∞—Ç–æ
    —Ç—ä—Ä—Å–∏ –¥–∏—Ä–µ–∫—Ç–Ω–æ HTML —Ç–∞–≥–æ–≤–µ.
    """
    KAUFLAND_URL = "https://www.kaufland.bg/aktualni-predlozheniya/ot-ponedelnik.html"
    product_list = []
    product_names_seen = set()

    # -----------------------------------------------------------------
    # ‚ö†Ô∏è –í–ê–ñ–ù–û: –¢—É–∫ —Ç—Ä—è–±–≤–∞ –¥–∞ —Å–ª–æ–∂–∏—à –ö–õ–ê–°–ê, –∫–æ–π—Ç–æ —Ç–∏ –Ω–∞–º–µ—Ä–∏!
    # -----------------------------------------------------------------
    THE_CORRECT_CLASS = 'k-product-tile__title'  # üëà –ó–ê–ú–ï–ù–ò –¢–û–í–ê –° –¢–í–û–Ø –†–ê–ë–û–¢–ï–© –ö–õ–ê–°

    if "product-tile__title" == THE_CORRECT_CLASS:
        print("‚ö†Ô∏è [Scraper] –í–Ω–∏–º–∞–Ω–∏–µ: –ö–ª–∞—Å—ä—Ç –∑–∞ Kaufland –µ 'product-tile__title'. –ê–∫–æ –Ω–µ —Ä–∞–±–æ—Ç–∏, —Å–º–µ–Ω–∏ –≥–æ –≤ logic.py.")

    print(f"ü§ñ [Scraper] –°–≤—ä—Ä–∑–≤–∞–º —Å–µ —Å Kaufland...")

    try:
        headers = {'User-Agent': 'Mozilla/5.0'}
        response = requests.get(KAUFLAND_URL, headers=headers, timeout=10)
        response.raise_for_status()

        print("... [Scraper] HTML –ø–æ–ª—É—á–µ–Ω. –¢—ä—Ä—Å—è HTML —Ç–∞–≥–æ–≤–µ...")
        soup = BeautifulSoup(response.content, 'html.parser')

        product_elements = soup.find_all('div', class_=THE_CORRECT_CLASS)

        if not product_elements:
            print(f"‚ùå [Scraper] –ì–†–ï–®–ö–ê: –ù–µ –º–æ–∂–∞—Ö –¥–∞ –Ω–∞–º–µ—Ä—è –µ–ª–µ–º–µ–Ω—Ç–∏ —Å '{THE_CORRECT_CLASS}'.")
            return

        for element in product_elements:
            title = element.get_text(strip=True)
            if title and title not in product_names_seen:
                product_list.append({"name": title})
                product_names_seen.add(title)

        print(f"‚úÖ [Scraper] –£—Å–ø–µ—à–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏ {len(product_list)} –ø—Ä–æ–¥—É–∫—Ç–∞ –æ—Ç Kaufland.")

        database.add_promotions(db_conn, product_list, 'Kaufland')

    except Exception as e:
        print(f"‚ùå‚ùå‚ùå [Scraper] –ö–†–ò–¢–ò–ß–ù–ê –ì–†–ï–®–ö–ê –≤ get_kaufland_promotions: {e}")


def get_lidl_promotions(db_conn):
    """
    Scraper-—ä—Ç –∑–∞ Lidl –µ –≤—Ä–µ–º–µ–Ω–Ω–æ —Å–ø—Ä—è–Ω (–¥–µ–∞–∫—Ç–∏–≤–∏—Ä–∞–Ω).
    """
    print(f"‚ö†Ô∏è [Scraper] Scraper-—ä—Ç –∑–∞ Lidl –µ –≤—Ä–µ–º–µ–Ω–Ω–æ —Å–ø—Ä—è–Ω (–¥–µ–∞–∫—Ç–∏–≤–∏—Ä–∞–Ω).")
    return


# ===================================================================
# –ß–ê–°–¢ 2: AI –Ø–î–†–û
# ===================================================================

def find_available_model() -> str:
    """
    –°–∞–º–æ–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: –Ω–∞–º–∏—Ä–∞ –ø—ä—Ä–≤–∏—è –Ω–∞–ª–∏—á–µ–Ω –º–æ–¥–µ–ª,
    –∫–æ–π—Ç–æ –ø–æ–¥–¥—ä—Ä–∂–∞ 'generateContent'.
    """
    print("üïµÔ∏è  [Logic] –ü—Ä–æ–≤–µ—Ä—è–≤–∞–º –Ω–∞–ª–∏—á–Ω–∏—Ç–µ AI –º–æ–¥–µ–ª–∏...")
    try:
        # ‚ö†Ô∏è –°–µ–≥–∞ —Ç–∞–∑–∏ —Ñ—É–Ω–∫—Ü–∏—è —â–µ —Ä–∞–±–æ—Ç–∏, –∑–∞—â–æ—Ç–æ genai –í–ï–ß–ï –ï –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–∞–Ω
        models = genai.list_models()
        for m in models:
            if 'generateContent' in m.supported_generation_methods:
                print(f"üëç [Logic] –©–µ –∏–∑–ø–æ–ª–∑–≤–∞–º –º–æ–¥–µ–ª: {m.name}")
                return m.name

        print("‚ùå [Logic] –ö–†–ò–¢–ò–ß–ù–ê –ì–†–ï–®–ö–ê: –ù–µ –µ –Ω–∞–º–µ—Ä–µ–Ω AI –º–æ–¥–µ–ª.")
        raise Exception("–ù–µ –µ –Ω–∞–º–µ—Ä–µ–Ω AI –º–æ–¥–µ–ª, –∫–æ–π—Ç–æ –¥–∞ –ø–æ–¥–¥—ä—Ä–∂–∞ 'generateContent'.")

    except Exception as e:
        print(f"‚ùå [Logic] –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–∑–±—Ä–æ—è–≤–∞–Ω–µ –Ω–∞ AI –º–æ–¥–µ–ª–∏: {e}")
        # –ü—Ä–µ–ø—Ä–µ–¥–∞–≤–∞–º–µ –æ—Ä–∏–≥–∏–Ω–∞–ª–Ω–∞—Ç–∞ –≥—Ä–µ—à–∫–∞, –∑–∞ –¥–∞ —è –≤–∏–¥–∏–º
        raise e


AI_MODEL_NAME = None
try:
    AI_MODEL_NAME = find_available_model()
except Exception as e:
    print(f"‚ùå [Logic] –ö–†–ò–¢–ò–ß–ù–ê –ì–†–ï–®–ö–ê –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ: –ù–µ –º–æ–≥–∞ –¥–∞ –Ω–∞–º–µ—Ä—è AI –º–æ–¥–µ–ª: {e}")
    # –ù–µ —Å–ø–∏—Ä–∞–º–µ, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ –º–æ–∂–µ –¥–∞ –ø—Ä–æ–¥—ä–ª–∂–∏ –∏ –¥–∞ –ø–æ–∫–∞–∂–µ –≥—Ä–µ—à–∫–∞ –≤ UI


def generate_recipe_prompt(promo_products, people, preferences, fridge_items: str):
    """
    –°—ä–∑–¥–∞–≤–∞ –ø–æ–¥—Ä–æ–±–Ω–∞—Ç–∞ –∑–∞—è–≤–∫–∞ (prompt) –∑–∞ AI –º–æ–¥–µ–ª–∞,
    –∫–∞—Ç–æ –≤–∫–ª—é—á–≤–∞ –∏ –ø—Ä–æ–¥—É–∫—Ç–∏—Ç–µ –æ—Ç —Ö–ª–∞–¥–∏–ª–Ω–∏–∫–∞.
    """
    product_names = [f"{p.get('name')} (–æ—Ç {p.get('store')})" for p in promo_products if p.get('name')]
    promo_list = "\n- " + "\n- ".join(list(set(product_names[:40])))

    servings_str = str(people)

    # -----------------------------------------------------------------
    # ‚ö†Ô∏è –ù–û–í–ê –î–ò–ù–ê–ú–ò–ß–ù–ê –°–ï–ö–¶–ò–Ø ‚ö†Ô∏è
    # -----------------------------------------------------------------
    # –°—ä–∑–¥–∞–≤–∞–º–µ —Å–µ–∫—Ü–∏—è –∑–∞ —Ö–ª–∞–¥–∏–ª–Ω–∏–∫–∞, –°–ê–ú–û –∞–∫–æ –ø–æ–ª–µ—Ç–æ –Ω–µ –µ –ø—Ä–∞–∑–Ω–æ
    fridge_prompt_section = "" # –ü–æ –ø–æ–¥—Ä–∞–∑–±–∏—Ä–∞–Ω–µ –µ –ø—Ä–∞–∑–Ω–æ
    if fridge_items:
        fridge_prompt_section = f"""
    –ü–†–û–î–£–ö–¢–ò –û–¢ –•–õ–ê–î–ò–õ–ù–ò–ö–ê (–ó–ê–î–™–õ–ñ–ò–¢–ï–õ–ù–ò):
    - {fridge_items}

    –¢–≤–æ—è—Ç–∞ –∑–∞–¥–∞—á–∞ –µ –¥–∞ –ò–ó–ü–û–õ–ó–í–ê–® —Ç–µ–∑–∏ –ø—Ä–æ–¥—É–∫—Ç–∏, –∑–∞ –¥–∞ –¥–æ–ø—ä–ª–Ω–∏—à —Ä–µ—Ü–µ–ø—Ç–∞—Ç–∞ 
    –∏ –¥–∞ –Ω–∞–º–∞–ª–∏—à –Ω—É–∂–Ω–∏—Ç–µ –ø–æ–∫—É–ø–∫–∏ –æ—Ç –º–∞–≥–∞–∑–∏–Ω–∞.
    """
    # -----------------------------------------------------------------

    prompt = f"""
    –¢–∏ —Å–∏ AI –∞—Å–∏—Å—Ç–µ–Ω—Ç-–≥–æ—Ç–≤–∞—á. –¢–≤–æ—è—Ç–∞ –∑–∞–¥–∞—á–∞ –µ –¥–∞ —Å—ä–∑–¥–∞–¥–µ—à 2 (–¥–≤–µ) –ª–µ—Å–Ω–∏ —Ä–µ—Ü–µ–ø—Ç–∏,
    –∫–æ–∏—Ç–æ –∫–æ–º–±–∏–Ω–∏—Ä–∞—Ç –ø—Ä–æ–¥—É–∫—Ç–∏—Ç–µ –æ—Ç —Ö–ª–∞–¥–∏–ª–Ω–∏–∫–∞ –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è —Å –ø—Ä–æ–¥—É–∫—Ç–∏—Ç–µ –Ω–∞ –ø—Ä–æ–º–æ—Ü–∏—è.

    {fridge_prompt_section} 

    –°–ü–ò–°–™–ö –° –ü–†–û–ú–û –ü–†–û–î–£–ö–¢–ò (–ó–ê –í–î–™–•–ù–û–í–ï–ù–ò–ï):
    {promo_list}

    –ü–û–¢–†–ï–ë–ò–¢–ï–õ–°–ö–ò –ò–ó–ò–°–ö–í–ê–ù–ò–Ø:
    - –ü–æ—Ä—Ü–∏–∏: {people}
    - –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–Ω–∏—è: {preferences}

    –°–¢–†–ò–ö–¢–ù–ò –ü–†–ê–í–ò–õ–ê:
    1. –¢–†–Ø–ë–í–ê –¥–∞ —Å–µ —Å—ä–æ–±—Ä–∞–∑–∏—à —Å –í–°–ò–ß–ö–ò –∏–∑–∏—Å–∫–≤–∞–Ω–∏—è –≤ "–ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–Ω–∏—è".
    2. –¢–†–Ø–ë–í–ê –¥–∞ –≤–∫–ª—é—á–∏—à –ø—Ä–æ–¥—É–∫—Ç–∏—Ç–µ –æ—Ç "–•–ª–∞–¥–∏–ª–Ω–∏–∫–∞".
    3. –¢–†–Ø–ë–í–ê –¥–∞ –∏–∑–ø–æ–ª–∑–≤–∞—à –ø—Ä–æ–¥—É–∫—Ç–∏ –æ—Ç "–ü—Ä–æ–º–æ—Ü–∏–∏", –∑–∞ –¥–∞ –¥–æ–ø—ä–ª–Ω–∏—à —Ä–µ—Ü–µ–ø—Ç–∞—Ç–∞.
    
    –í–ê–ñ–ù–ê –ó–ê–î–ê–ß–ê –ó–ê –ò–ó–ß–ò–°–õ–ï–ù–ò–ï:
    –ò–∑—á–∏—Å–ª–∏ –ü–†–ò–ë–õ–ò–ó–ò–¢–ï–õ–ù–ê –æ–±—â–∞ —Ü–µ–Ω–∞ –í –õ–ï–í–ê —Å–∞–º–æ –∑–∞ —Å—ä—Å—Ç–∞–≤–∫–∏—Ç–µ, –∫–æ–∏—Ç–æ 
    —Ç—Ä—è–±–≤–∞ –¥–∞ —Å–µ –ö–£–ü–Ø–¢ (—Ç.–µ. –ü—Ä–æ–º–æ –ø—Ä–æ–¥—É–∫—Ç–∏ + –†–µ–¥–æ–≤–Ω–∞ —Ü–µ–Ω–∞). 
    –ù–µ –≤–∫–ª—é—á–≤–∞–π –≤ —Ü–µ–Ω–∞—Ç–∞ –ø—Ä–æ–¥—É–∫—Ç–∏—Ç–µ –æ—Ç —Ö–ª–∞–¥–∏–ª–Ω–∏–∫–∞.

    –ò–ù–°–¢–†–£–ö–¶–ò–ò –ó–ê –ò–ó–•–û–î–ù–ò–Ø –§–û–†–ú–ê–¢:
    –¢—Ä—è–±–≤–∞ –¥–∞ –æ—Ç–≥–æ–≤–æ—Ä–∏—à –°–ê–ú–û —Å –≤–∞–ª–∏–¥–µ–Ω JSON –æ–±–µ–∫—Ç...

    {{
      "recipes": [
        {{
          "title": "–ò–º–µ –Ω–∞ –†–µ—Ü–µ–ø—Ç–∞ 1",
          "price_estimate": "–æ–∫–æ–ª–æ 5.50 –ª–≤. (–Ω—É–∂–Ω–∏ –ø—Ä–æ–¥—É–∫—Ç–∏)", // –¢–≤–æ—è—Ç–∞ –ü–†–ò–ë–õ–ò–ó–ò–¢–ï–õ–ù–ê –æ—Ü–µ–Ω–∫–∞
          "servings": "{servings_str}",
          "prep_time": "30 –º–∏–Ω",
          "ingredients": [
            {{ "item": "3 –±—Ä. –Ø–π—Ü–∞", "note": "–û—Ç —Ö–ª–∞–¥–∏–ª–Ω–∏–∫–∞" }},
            {{ "item": "100 –≥—Ä. –°–∏—Ä–µ–Ω–µ", "note": "–û—Ç —Ö–ª–∞–¥–∏–ª–Ω–∏–∫–∞" }},
            {{ "item": "200 –≥—Ä. –°–ø–∞–Ω–∞–∫", "note": "–ü–†–û–ú–û–¶–ò–Ø –æ—Ç Kaufland" }},
            {{ "item": "1/2 –≥–ª. –õ—É–∫", "note": "–†–µ–¥–æ–≤–Ω–∞ —Ü–µ–Ω–∞" }}
          ],
          "instructions": [
            "–°—Ç—ä–ø–∫–∞ 1...",
            "–°—Ç—ä–ø–∫–∞ 2..."
          ]
        }},
        ... // (–∏ –†–µ—Ü–µ–ø—Ç–∞ 2)
      ]
    }}
    """
    return prompt


# ===================================================================
# –ß–ê–°–¢ 3: –ì–õ–ê–í–ù–ê –§–£–ù–ö–¶–ò–Ø
# ===================================================================

def get_recipes_for_user(db_conn, people: str, preferences_list: list, stores: list, fridge_items: str) -> Dict[str, Any]:
    """
    –¢–æ–≤–∞ –µ –≥–ª–∞–≤–Ω–∞—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—è—Ç–æ –∏–∑–ø—ä–ª–Ω—è–≤–∞ —Ü—è–ª–∞—Ç–∞ –ª–æ–≥–∏–∫–∞.
    –¢—è –í–ï–ß–ï –°–ê–ú–û –ß–ï–¢–ï –æ—Ç –±–∞–∑–∞—Ç–∞ –¥–∞–Ω–Ω–∏.
    """
    global AI_MODEL_NAME

    if not AI_MODEL_NAME:
        # –¢–∞–∑–∏ –≥—Ä–µ—à–∫–∞ –≤–µ—á–µ —â–µ —Å–µ –≤–∏–∂–¥–∞ –ø–æ-—è—Å–Ω–æ –æ—Ç –≥–æ—Ä–Ω–∏—è try/except
        raise Exception("AI –ú–æ–¥–µ–ª—ä—Ç –Ω–µ –µ –∑–∞—Ä–µ–¥–µ–Ω –ø—Ä–∞–≤–∏–ª–Ω–æ. –ü—Ä–æ–≤–µ—Ä–∏ 'logic.py' –∑–∞ –≥—Ä–µ—à–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ.")

    try:
        # 1. –ò–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç–∏—Ç–µ –æ—Ç DB
        print(f"‚ö°Ô∏è [Logic] –ò–∑–≤–ª–∏—á–∞–º –ø—Ä–æ–¥—É–∫—Ç–∏ –æ—Ç DB –∑–∞ –º–∞–≥–∞–∑–∏–Ω–∏: {stores or '–í–°–ò–ß–ö–ò'}...")
        promo_products = database.get_recent_promotions(db_conn, stores)

        if not promo_products:
            raise Exception("–ë–∞–∑–∞—Ç–∞ –¥–∞–Ω–Ω–∏ –µ –ø—Ä–∞–∑–Ω–∞. Scraper-—ä—Ç –Ω–µ –µ —É—Å–ø—è–ª –¥–∞ –∏–∑–≤–ª–µ—á–µ –¥–∞–Ω–Ω–∏.")

        print(f"‚ö°Ô∏è [Logic] –ù–∞–º–µ—Ä–µ–Ω–∏ {len(promo_products)} –ø—Ä–æ–¥—É–∫—Ç–∞ –≤ DB.")

        # 2. –§–æ—Ä–º–∞—Ç–∏—Ä–∞–Ω–µ –Ω–∞ —Ñ–∏–ª—Ç—Ä–∏—Ç–µ
        if not preferences_list:
            preferences_list.append("–±–µ–∑ —Å–ø–µ—Ü–∏–∞–ª–Ω–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è")
        preferences_str = ", ".join(preferences_list)

        # 3. –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ prompt
        prompt = generate_recipe_prompt(promo_products, people, preferences_str, fridge_items)

        # 4. –ò–∑–≤–∏–∫–≤–∞–Ω–µ –Ω–∞ AI –≤ JSON –†–ï–ñ–ò–ú
        print("üß† [Logic] –ò–∑–ø—Ä–∞—â–∞–º –∑–∞—è–≤–∫–∞ –∫—ä–º AI (–≤ JSON —Ä–µ–∂–∏–º)...")
        model = genai.GenerativeModel(AI_MODEL_NAME)

        response = model.generate_content(
            prompt,
            generation_config={"response_mime_type": "application/json"}
        )

        print("‚úÖ [Logic] AI –≤—ä—Ä–Ω–∞ JSON –æ—Ç–≥–æ–≤–æ—Ä.")

        # 5. –ü–∞—Ä—Å–≤–∞–Ω–µ –Ω–∞ JSON-–∞ –≤ Python —Ä–µ—á–Ω–∏–∫
        return json.loads(response.text)

    except json.JSONDecodeError:
        print(f"‚ùå [Logic] –ö–†–ò–¢–ò–ß–ù–ê –ì–†–ï–®–ö–ê: AI –≤—ä—Ä–Ω–∞ –Ω–µ–≤–∞–ª–∏–¥–µ–Ω JSON!")
        print(f"–°—É—Ä–æ–≤ –æ—Ç–≥–æ–≤–æ—Ä: {response.text}")
        raise Exception("AI –≤—ä—Ä–Ω–∞ –æ—Ç–≥–æ–≤–æ—Ä –≤ –Ω–µ–æ—á–∞–∫–≤–∞–Ω —Ñ–æ—Ä–º–∞—Ç. –ú–æ–ª—è, –æ–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ.")
    except Exception as e:
        print(f"‚ùå [Logic] –ü—ä–ª–Ω–∞ –≥—Ä–µ—à–∫–∞ –≤ get_recipes_for_user: {e}")
        raise e